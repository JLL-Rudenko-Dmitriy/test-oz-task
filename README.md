# Тестовое задание 
> (реализовать сервис работы с системой отчетов)

---
## Постановка задачи
### Реализовать сервис работы с системой отчетов по конверсии просмотров/оплат определенных товаров.
С помощью сервиса требуется уменьшить затраты на составление отчетов, так как затраты на составление одного отчета равны затратам на составление нескольких отчётов, тогда выгоднее составлять несколько запросов за раз.
Пользователи в течении дня могут запрашивать несколько запросов.

Пользователи за рабочий день могут запросить несколько отчетов. 
Пользователь сервиса может ждать отчета сутки.
В ожидании отчета пользователи могут часто вызывать эндопионт, что может давать сбой в работе базы сервиса.

---
Технические требования:
- Сервис написан на C#
- Шина сообщений Kafka (в моем случае)
- Реляционная БД: PostgreSQL
- Не реляционная БД: Redis
- Интерфейс взаимодействия для получения результатов отчета - GRPC
- Есть docker-compose файл для запуска всех частей сервиса
- Все тесты расположены в папке Tests

---

# Запуск решения

Весь сервис для внешнего взаимодействия можно поднять с помощью docker compose файла.
```
 docker compose -f ./docker-compose.yml -p paymentconversion up -d
```

## Предварительная генерация данных
Для обращений к сервису можно предварительно сгенерировать тестовые данные, для этого нужно запустить несколько раз запустить
console app из Migrations.

# Как работает мое решение (коротко):
Для взаимодействия с сервисом есть два консьюмера:
  - FastConsumer - Передает данные для сервиса, который регистрирует каждое обращение на создание отчета затем при достижении условий на кол-во сообщений оповещает BatchConsumer
  - BatchConsumer - По достижению временных условий или достаточного кол-ва накопленных сообщений пачкой генерирует отчёты.
    - Для изменения ограничений есть две переменных в docker compose:
      - MESSAGE_LIMIT_PER_CONSUMER: 512 (по умолчанию)
      - BATCH_CONSUMER_HOURS_INTERVAL: 12 (по умолчанию)

Для вызова основной бизнес-логики есть два GRPC сервиса:
  - Первый отвечает за бизнес логику работы с заявками на отчет и выдачу готовых отчетов
  - Второй отвечает только за генерацию отчётов

# Как получить отчет
**Пример тела запроса:**
_(Чтобы получить отчет, он должен быть предварительно сгенерирован)_
```
{
  "case_id": "1dd23daf-243f-437e-ad34-0c1c4ad3da81"
}
```
**Пример тела ответа:**
_(Отчет готов)_
```
{
  "report": {
    "conversion_ratio": 570.5714285714286,
    "payments_count": "224"
  },
  "result": "report"
}
```
_(Отчет не готов)_
```
{
  "report": {
    "status": "Report is not done! Report status is Pending"
  },
  "result": "status"
}
```

# Диаграмма таблиц из БД
![postgrs@localhost](https://github.com/user-attachments/assets/511b0971-de8d-4739-b0e8-37a6cfd3b985)


